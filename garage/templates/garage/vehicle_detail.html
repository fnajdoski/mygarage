{% extends 'garage/base.html' %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2>Maintenance History ‚Äì {{ vehicle.name }} ({{ vehicle.year }})</h2>
    <a href="{% url 'vehicle_list' %}" class="btn neon-button">Back to List</a>
</div>

<div class="maintenance-section" style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; align-items: start;">
    <div class="glass-card log-service-card">
        <h3 style="color: var(--neon-blue); margin-bottom: 1.5rem;">Log Service</h3>
        <form action="{% url 'log_service' vehicle.pk %}" method="post">
            {% csrf_token %}
            <div class="form-group">
                <label for="service_type">Service Type</label>
                <select name="service_type" id="service_type" required>
                    {% for service in service_types %}
                    <option value="{{ service.pk }}">{{ service.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="date">Date</label>
                <input type="date" name="date" id="date" value="{% now 'Y-m-d' %}" required>
            </div>
            <div class="form-group">
                <label for="mileage_km">Mileage (km)</label>
                <input type="number" name="mileage_km" id="mileage_km" value="{{ vehicle.current_odometer_km }}"
                    required>
            </div>
            <div class="form-group">
                <label for="cost">Cost</label>
                <input type="number" step="0.01" name="cost" id="cost" placeholder="0.00" required>
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea name="notes" id="notes" rows="3"></textarea>
            </div>

            <!-- AI Cost Prediction Placeholder -->
            <div id="ai-cost-prediction" class="ai-prediction"
                style="display:none; background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
                <span class="icon">ü§ñ</span>
                <span class="text" style="color: var(--neon-blue);">Estimated Cost: <span id="predicted-cost"
                        style="font-weight: bold;">...</span></span>
            </div>

            <button type="submit" class="btn neon-button btn-block">Log Service</button>
        </form>
    </div>

    <div class="glass-card history-table-container">
        <h3 style="margin-bottom: 1.5rem;">History</h3>
        <div class="table-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Service</th>
                        <th>Mileage</th>
                        <th>Cost</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in history %}
                    <tr>
                        <td>{{ record.date }}</td>
                        <td>{{ record.service_type.name }}</td>
                        <td>{{ record.mileage_km }} km</td>
                        <td>‚Ç¨{{ record.cost }}</td>
                        <td>{{ record.notes }}</td>
                        <td>
                            <a href="{% url 'delete_service' record.pk %}" class="btn-icon delete" title="Delete"
                                style="text-decoration: none;">üóëÔ∏è</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-muted);">No maintenance records
                            found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const serviceSelect = document.getElementById('service_type');
        const predictionContainer = document.getElementById('ai-cost-prediction');
        const predictedCostSpan = document.getElementById('predicted-cost');
        const vehicleType = "{{ vehicle.type }}"; // Passed from context

        serviceSelect.addEventListener('change', function () {
            const serviceId = this.value;
            const serviceName = this.options[this.selectedIndex].text;

            if (serviceId) {
                fetch(`{% url 'predict_cost' %}?vehicle_type=${vehicleType}&service_type=${encodeURIComponent(serviceName)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.estimated_cost) {
                            predictedCostSpan.textContent = `‚Ç¨${data.estimated_cost}`;
                            predictionContainer.style.display = 'block';
                        } else {
                            predictionContainer.style.display = 'none';
                        }
                    })
                    .catch(err => {
                        console.error('Prediction error:', err);
                        predictionContainer.style.display = 'none';
                    });
            } else {
                predictionContainer.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}